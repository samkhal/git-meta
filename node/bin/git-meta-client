#!/usr/bin/env python3
# -*- coding: UTF-8 -*-

"""
Client for git-meta-server

This light client will capture
- Current working directory
- Args
- Stdin
and send it all to the server over a unix socket.

It will print out the server's response.
"""

import socket
import os
import sys

server_address = '/tmp/app.gitmeta'

# Get all stdin
cwd = os.getcwd()
command = " ".join(sys.argv[1:])
stdin = ""
if not sys.stdin.isatty(): # Check if theres anything on stdin to read
    stdin = sys.stdin.read()

message = "{};{};{}".format(cwd, command, stdin)

sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
try:
    sock.connect(server_address)
except ConnectionRefusedError:
    print("Could not connect to socket; make sure the git-meta server is running!", file=sys.stderr)
    exit(1)

sock.send(message.encode('UTF-8'))

data = b''
end_of_transmission = 0x04
while True:
    data += sock.recv(4096)
    if not data:
        print("Failed to recieve data from server!", file=sys.stderr)
        exit(1)
    elif data[-1] == end_of_transmission:
        data = data[:-1]
        break
sock.close()
    
print(data.decode('UTF-8'), end='')

